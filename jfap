#!/bin/bash
set -euo pipefail

# ───── Paths ─────
BASE_DIR="$HOME/.production_apps"

# ───── Session & Windows ─────
SESSION="dev"

# Window Names
WIN_MAIN="Running_Apps"

# ───── API Windows & Paths ─────
WIN_API_ENTRIES=(
  "PALLET_API=$BASE_DIR/palletapi"
  "LABEL_API=$BASE_DIR/labelapi"
  # "PACKING_LIST_API=$BASE_DIR/packing_list_api"
  "NUTRITIONALS_API=$BASE_DIR/nutritionals_api"
)

# ───── Frontend Windows & Paths ─────
WIN_FRONT_ENTRIES=(
  "PALLET_APP=$BASE_DIR/reactapp"
  "NUTRITIONALS_APP=$BASE_DIR/nutritionals_front_end"
)

# ───── Commands ─────
FASTAPI_VENV="source ../.venv/bin/activate"
FASTAPI_RUN="uvicorn main:app --host 0.0.0.0 --port 8000 --reload"
REACT_RUN="npm start"
GIT_STATUS="git checkout dev git status"

# ───── Create Session ─────
if ! tmux has-session -t "$SESSION" 2>/dev/null; then
    tmux new-session -d -s "$SESSION" -n "$WIN_MAIN"

    # ───── Main Window Panes ─────

    # Split horizontally
    tmux split-window -h -t "$SESSION:$WIN_MAIN"

    # Pane 0: FastAPI
    tmux send-keys -t "$SESSION:$WIN_MAIN.1" "cd \"$BASE_DIR/nutritionals_api/app\"" C-m
    tmux send-keys -t "$SESSION:$WIN_MAIN.1" "$FASTAPI_VENV" C-m
    tmux send-keys -t "$SESSION:$WIN_MAIN.1" "$FASTAPI_RUN" C-m

    # Pane 2: React
    tmux send-keys -t "$SESSION:$WIN_MAIN.2" "cd \"$BASE_DIR/nutritionals_front_end\"" C-m
    tmux send-keys -t "$SESSION:$WIN_MAIN.2" "$REACT_RUN" C-m

    # ───── API Windows ─────
    for entry in "${WIN_API_ENTRIES[@]}"; do
        IFS='=' read -r WIN_API APP_PATH <<< "$entry"
        tmux new-window -t "$SESSION" -n "$WIN_API"
        tmux send-keys -t "$SESSION:$WIN_API" "cd \"$APP_PATH/app\"" C-m
        tmux send-keys -t "$SESSION:$WIN_API" "$FASTAPI_VENV" C-m
        tmux send-keys -t "$SESSION:$WIN_API" "$GIT_STATUS" C-m
    done

    # ───── Frontend Windows ─────
    for entry in "${WIN_FRONT_ENTRIES[@]}"; do
        IFS='=' read -r WIN_FRONT FRONT_PATH <<< "$entry"
        tmux new-window -t "$SESSION" -n "$WIN_FRONT"
        tmux send-keys -t "$SESSION:$WIN_FRONT" "cd \"$FRONT_PATH/src\"" C-m
        tmux send-keys -t "$SESSION:$WIN_FRONT" "$GIT_STATUS" C-m
    done

    # Focus on the last created API window
    IFS='=' read -r LAST_API _ <<< "${WIN_API_ENTRIES[-1]}"
    tmux select-window -t "$SESSION:$LAST_API"
fi

# ───── Attach ─────
tmux attach -t "$SESSION"
