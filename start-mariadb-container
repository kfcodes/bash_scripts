#!/usr/bin/env bash
set -e

# ---- Must run as root ----
if [ "$EUID" -ne 0 ]; then
  echo "[mariadb] Please run as root (sudo)"
  exit 1
fi

# ---- Disable host MariaDB completely ----
if systemctl list-unit-files | grep -q '^mariadb\.service'; then
  echo "[mariadb] Stopping host MariaDB service"
  systemctl stop mariadb || true

  echo "[mariadb] Disabling host MariaDB service"
  systemctl disable mariadb || true

  echo "[mariadb] Masking host MariaDB service"
  systemctl mask mariadb || true
else
  echo "[mariadb] Host MariaDB service not found"
fi

# ---- Configuration ----
DB_NETWORK="db_net"
APP_NETWORK="application_network"

CONTAINER_NAME="mariadb"
VOLUME_NAME="mariadb_data"
IMAGE="mariadb:11"

MYSQL_ROOT_PASSWORD="rootpassword"
MYSQL_DATABASE="appdb"
MYSQL_USER="appuser"
MYSQL_PASSWORD="apppassword"
# -----------------------

echo "[mariadb] Starting MariaDB container setup at $(date)"

# Create DB network
if ! docker network inspect "$DB_NETWORK" >/dev/null 2>&1; then
  echo "[mariadb] Creating network: $DB_NETWORK"
  docker network create "$DB_NETWORK"
fi

# Create application network
if ! docker network inspect "$APP_NETWORK" >/dev/null 2>&1; then
  echo "[mariadb] Creating network: $APP_NETWORK"
  docker network create "$APP_NETWORK"
fi

# Create volume
if ! docker volume inspect "$VOLUME_NAME" >/dev/null 2>&1; then
  echo "[mariadb] Creating volume: $VOLUME_NAME"
  docker volume create "$VOLUME_NAME"
fi

# Remove existing container if present
if docker ps -a --format '{{.Names}}' | grep -qx "$CONTAINER_NAME"; then
  echo "[mariadb] Removing existing container"
  docker stop "$CONTAINER_NAME" >/dev/null 2>&1 || true
  docker rm "$CONTAINER_NAME"
fi

# Pull image if missing
if ! docker image inspect "$IMAGE" >/dev/null 2>&1; then
  echo "[mariadb] Pulling image: $IMAGE"
  docker pull "$IMAGE"
fi

# Start container on DB network
echo "[mariadb] Starting MariaDB container"

docker run -d \
  --name "$CONTAINER_NAME" \
  --network "$DB_NETWORK" \
  -p 3306:3306 \
  -v "$VOLUME_NAME:/var/lib/mysql" \
  -e MYSQL_ROOT_PASSWORD="$MYSQL_ROOT_PASSWORD" \
  -e MYSQL_DATABASE="$MYSQL_DATABASE" \
  -e MYSQL_USER="$MYSQL_USER" \
  -e MYSQL_PASSWORD="$MYSQL_PASSWORD" \
  --restart unless-stopped \
  "$IMAGE"

# Attach to application network
echo "[mariadb] Connecting container to $APP_NETWORK"
docker network connect "$APP_NETWORK" "$CONTAINER_NAME"

echo "[mariadb] MariaDB networks:"
docker inspect -f '{{range .NetworkSettings.Networks}}{{println .NetworkID}}{{end}}' "$CONTAINER_NAME"

echo "[mariadb] Done."
